(()=>{var e={};e.id=325,e.ids=[325],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},6812:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>m,routeModule:()=>p,serverHooks:()=>d,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>u});var a={};r.r(a),r.d(a,{POST:()=>c});var o=r(96559),i=r(48088),s=r(37719),n=r(32190),l=r(33180);async function c(e){try{let{layout:t,previewData:r}=await e.json();global.tempLayout=t;let a=await (0,l.Tn)({name:r.name||"MICHAEL",avatarUrl:"https://i.pravatar.cc/300",position:r.position||"TP 志愿者"},t);return new n.NextResponse(a,{headers:{"Content-Type":"image/png"}})}catch(e){return console.error("Error generating layout preview:",e),n.NextResponse.json({error:"Failed to generate layout preview"},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/preview-layout/route",pathname:"/api/preview-layout",filename:"route",bundlePath:"app/api/preview-layout/route"},resolvedPagePath:"/Users/lxc/Projects/aiagent/sweatshop_id_card/src/app/api/preview-layout/route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:g,workUnitAsyncStorage:u,serverHooks:d}=p;function m(){return(0,s.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:u})}},9288:e=>{"use strict";e.exports=require("sharp")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{"use strict";e.exports=require("assert")},21820:e=>{"use strict";e.exports=require("os")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33180:(e,t,r)=>{"use strict";r.d(t,{Iv:()=>g,Tn:()=>p});var a=r(88044),o=r(94612);let i=null,s=null,n=null;i=r(9288),s=r(29021),n=r(33873);try{console.log("将使用 Canvas 默认字体")}catch(e){console.error("字体处理出错:",e)}function l(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"):""}let c={avatar:{size:200,x:399,y:400,circleRadius:80},name:{x:400,y:580,fontSize:20,fontFamily:"sans-serif",fontWeight:"bold",color:"black",align:"center"},position:{x:400,y:650,fontSize:20,fontFamily:"sans-serif",fontWeight:"normal",color:"black",align:"center"}};async function p(e,t){console.log("Starting badge generation process..."),console.log("Avatar URL:",e.avatarUrl);let r=t||global.tempLayout||c,p=(0,a.createCanvas)(800,800),g=p.getContext("2d"),u=(0,a.createCanvas)(800,800),d=u.getContext("2d");try{let t,i;t=n?n.join(process.cwd(),"public/images/badge-template.png"):"/images/badge-template.png",console.log("Template path:",t);let l=!s||s.existsSync(t);console.log("Template exists check:",l);try{i=await (0,a.loadImage)(l?t:"https://raw.githubusercontent.com/lxcong/sweatshop_id_card/master/public/images/badge-template.png"),console.log("Template image loaded from:",l?"local file":"GitHub")}catch(o){console.error("Failed to load template from primary sources, creating basic template");let e=(0,a.createCanvas)(800,800),t=e.getContext("2d");t.fillStyle="#FECF33",t.fillRect(0,0,800,800),t.fillStyle="#000000",t.font="bold 36px Arial",t.textAlign="center",t.fillText("SWEATSHOP",400,150);let r=e.toBuffer("image/png");i=await (0,a.loadImage)(r)}try{if(!e.avatarUrl||"undefined"===e.avatarUrl)throw Error("Invalid avatar URL");console.log("Downloading avatar from:",e.avatarUrl);let t=await o.A.get(e.avatarUrl,{responseType:"arraybuffer",headers:{Accept:"image/jpeg, image/png, image/*","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}});console.log("Avatar downloaded successfully");let i=await (0,a.loadImage)(Buffer.from(t.data,"binary"));console.log("Avatar loaded to canvas"),d.beginPath(),d.arc(r.avatar.x,r.avatar.y,r.avatar.circleRadius,0,2*Math.PI,!0),d.closePath(),d.clip(),d.drawImage(i,r.avatar.x-r.avatar.size/2,r.avatar.y-r.avatar.size/2,r.avatar.size,r.avatar.size),console.log("Avatar drawn with circular mask")}catch(e){console.error("Error loading avatar:",e),d.fillStyle="#808080",d.beginPath(),d.arc(r.avatar.x,r.avatar.y,r.avatar.circleRadius,0,2*Math.PI,!0),d.closePath(),d.fill()}g.drawImage(u,0,0),g.drawImage(i,0,0,800,800),console.log("Template image loaded successfully")}catch(e){console.error("Error loading template:",e),g.fillStyle="#FECF33",g.fillRect(0,0,800,800)}let m=p.toBuffer("image/png");if(!i)return console.log("Badge generation completed without Sharp text rendering (client-side)"),m;try{let t=l(e.name||"Unknown User"),a=e.position?l(e.position):"";console.log("Preparing text rendering:"),console.log("- Name (escaped):",t),console.log("- Position (escaped):",a);let o=`
        <svg width="800" height="800">
          <style>
            .name { 
              font: bold 20px "PingFang SC", "Microsoft YaHei", "SimHei", "Noto Sans SC", sans-serif; 
              white-space: pre;
            }
            .position { 
              font: 20px "PingFang SC", "Microsoft YaHei", "SimHei", "Noto Sans SC", sans-serif; 
              white-space: pre;
            }
          </style>
          <text 
            x="${r.name.x}" 
            y="${r.name.y}" 
            text-anchor="middle" 
            dominant-baseline="middle"
            class="name" 
            fill="black"
          >${t}</text>
          ${a?`
            <text 
              x="${r.position.x}" 
              y="${r.position.y}" 
              text-anchor="middle" 
              dominant-baseline="middle"
              class="position" 
              fill="black"
            >${a}</text>
          `:""}
        </svg>`;console.log("Created SVG text layer with enhanced Unicode support");let s=await i(m).composite([{input:Buffer.from(o,"utf-8"),gravity:"center"}]).png().toBuffer();return console.log("Badge generation completed with Sharp text rendering"),s}catch(e){console.error("Error rendering text with Sharp:",e);try{console.log("Attempting simpler SVG text rendering as fallback");let e=`
          <svg width="800" height="800">
            <text x="${r.name.x}" y="${r.name.y}" font-family="sans-serif" font-size="20" text-anchor="middle" fill="black">Badge Text</text>
          </svg>`,t=await i(m).composite([{input:Buffer.from(e,"utf-8"),gravity:"center"}]).png().toBuffer();return console.log("Fallback simple text rendering completed"),t}catch(e){return console.error("Even fallback text rendering failed:",e),console.log("Badge generation completed without text"),m}}}function g(e){if(!e||(console.log("Original Twitter image URL:",e),!e||"undefined"===e))return"";if(e.includes("profile_images")){let t=e.replace("_normal","");return console.log("Transformed Twitter image URL:",t),t}return console.log("URL was not modified:",e),e}},33873:e=>{"use strict";e.exports=require("path")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},88044:e=>{"use strict";e.exports=require("canvas")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[243,580,612],()=>r(6812));module.exports=a})();